<!--BeeBee-66 brushless quad airframe
  Lisa/S V2.0 AP
  Serial Telemetry
  UBlox Max7Q GPS
  SBUS FrSky -->

<airframe name="quadrotor lisa_s 2">

  <firmware name="rotorcraft">
    <target name="ap" board="lisa_s_2.0">
      <configure name="PERIODIC_FREQUENCY"  value="500"/>
      
      <module name="radio_control" type="sbus">
        <!-- Put the mode on channel AUX1-->
        <define name="RADIO_KILL_SWITCH" value="RADIO_GAIN1"/>
      </module>

      <module name="motor_mixing"/>
    </target>

    <target name="nps" board="pc">
      <module name="fdm" type="jsbsim"/>
      <module name="udp"/>
      <module name="radio_control" type="datalink"/>
      <module name="logger_file">
        <define name="FILE_LOGGER_PATH" value="/home/esdentem/Documents"/>
      </module>
    </target>

    <module name="actuators"     type="pwm">
      <define name="SERVO_HZ" value="400"/>
    </module>

    <module name="send_imu_mag_current"/>
    <module name="sys_mon"/>

    <module name="telemetry"     type="transparent"/>
    <module name="imu" type="lisa_s_v2.0"/>

    <module name="gps"           type="ublox"/>
    <module name="stabilization" type="indi"/>

    <module name="ahrs"          type="int_cmpl_quat"/>
    <module name="ins"/>
    <module name="gps" type="ubx_ucenter"/>

  </firmware>

  <firmware name="test_chibios">
    <target name="test_sys_time_timer" board="lisa_s_2.0"/>
    <target name="test_led" board="lisa_s_2.0"/>
    <target name="test_sys_gpio" board="lisa_s_2.0"/>
    <target name="test_serial" board="lisa_s_2.0">
	    <define name="SERIAL_PORT" value="uart2"/>
	    <define name="USE_UART2"/>
	    <define name="UART2_BAUD" value="B57600"/>
    </target>
    <target name="test_telemetry" board="lisa_s_2.0"/>
  </firmware>


  <servos driver="Pwm">
    <servo name="FR" no="0" min="1000" neutral="1100" max="2000"/>
    <servo name="BR" no="1" min="1000" neutral="1100" max="2000"/>
    <servo name="BL" no="2" min="1000" neutral="1100" max="2000"/>
    <servo name="FL" no="3" min="1000" neutral="1100" max="2000"/>
    <!--<servo name="SERVO_TEST" no="4" min="1000" neutral="1500" max="2000"/>-->
  </servos>

  <commands>
    <axis name="PITCH"  failsafe_value="0"/>
    <axis name="ROLL"   failsafe_value="0"/>
    <axis name="YAW"    failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>

  <section name="MIXING" prefix="MOTOR_MIXING_">
    <!-- front left (CW), front right (CCW), back right (CW), back left (CCW) -->
    <define name="TYPE" value="QUAD_X"/>
  </section>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
    <set servo="FR" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
    <set servo="BR" value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
    <set servo="BL" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
    <set servo="FL" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
  </command_laws>

  <section name="IMU" prefix="IMU_">
    <!-- IMU mag calibration, make sure to calibrate the IMU properly before flight, see the wiki for more info-->
    <!--Mag of gps-->
    <define name="MAG_X_NEUTRAL" value="195"/>
    <define name="MAG_Y_NEUTRAL" value="-47"/>
    <define name="MAG_Z_NEUTRAL" value="-25"/>
    <define name="MAG_X_SENS" value="3.68245686199" integer="16"/>
    <define name="MAG_Y_SENS" value="3.81802043484" integer="16"/>
    <define name="MAG_Z_SENS" value="4.01084591146" integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI"   value="0." unit="deg"/>
  </section>

  <section name="BAT">
    <!--<define name="MILLIAMP_AT_FULL_THROTTLE" value="14000"/>-->
    <define name="CATASTROPHIC_BAT_LEVEL" value="4.0" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="4.4" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="4.5" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="4.8" unit="V"/>
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI"     value="60." unit="deg"/>
    <define name="SP_MAX_THETA"   value="60." unit="deg"/>
    <define name="SP_MAX_R"       value="90." unit="deg/s"/>
    <define name="DEADBAND_R"     value="250"/>
    <define name="DEADBAND_A"     value="250"/>
    <define name="SP_PSI_DELTA_LIMIT" value="90" unit="deg"/>
  </section>

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness, scaled by INDI_G_SCALING (1000)-->
    <define name="G1_ROLL"   value="{   0,    0,  -13.3,  13.3}"/>
    <define name="G1_PITCH"  value="{-2.1,  2.1,      0,     0}"/>
    <define name="G1_YAW"    value="{-2.0, -2.0,    0.0,   0.0}"/>
    <define name="G1_THRUST" value="{   0,    0,   -1.1,  -1.1}"/>
    <!--Counter torque effect of spinning up a rotor-->
    <define name="G2" value="{0, 0, 0, 0}"/>

    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="107.0"/>
    <define name="REF_ERR_Q" value="200.0"/>
    <define name="REF_ERR_R" value="200.0"/>
    <define name="REF_RATE_P" value="14.0"/>
    <define name="REF_RATE_Q" value="15.0"/>
    <define name="REF_RATE_R" value="15.0"/>

    <!--Maxium yaw rate, to avoid instability-->
    <define name="MAX_R" value="100.0" unit="deg/s"/>

    <define name="ESTIMATION_FILT_CUTOFF" value="4.0"/>
    <define name="FILT_CUTOFF" value="5.0"/>

    <!-- first order actuator dynamics -->
    <define name="ACT_DYN" value="{0.1, 0.1, 0.045, 0.045}"/>
    <define name="ACT_RATE_LIMIT" value="{170, 170, 9600, 9600}"/>
    <define name="ACT_IS_SERVO" value="{1, 1, 0, 0}"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>
  </section>

  <!-- Gains for vertical navigation -->
  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP"    value="200"/>
    <define name="HOVER_KD"    value="175"/>
    <define name="HOVER_KI"    value="72"/>
    <define name="NOMINAL_HOVER_THROTTLE" value ="0.4"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE"/>
  </section>

  <section name="NAV">
    <define name="NAV_CLIMB_VSPEED" value="1.5"/>
    <define name="NAV_DESCEND_VSPEED" value="-0.8"/>
  </section>

  <section name="INS" prefix="INS_">
    <define name="H_X" value="0.5138"/>
    <define name="H_Y" value="0.00019"/>
    <define name="H_Z" value="0.8578"/>
  </section>

  <!-- Gains for horizontal navigation-->
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="PGAIN" value="100"/>
    <define name="DGAIN" value="100"/>
    <define name="IGAIN" value="0"/>
  </section>

  <section name="MISC">
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>

    <define name="BARO_PERIODIC_FREQUENCY" value="50"/>
    <define name="GUIDANCE_H_MAX_BANK" value="60" unit="deg"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="ele_left, ele_right, mot_right, mot_left" type="string[]"/>
    <define name="JSBSIM_MODEL" value="cyclone" type="string"/>
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
    <define name="NO_MOTOR_MIXING" value="TRUE"/>
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_MANUAL"  value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_FORWARD"/>
    <define name="MODE_AUTO2"  value="AP_MODE_NAV"/>
    <define name="MODE_STARTUP"  value="AP_MODE_NAV"/>
  </section>

</airframe>
